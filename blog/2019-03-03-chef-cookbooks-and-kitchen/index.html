<!doctype html><html><head><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Pagekit"><link rel=canonical href=https://www.p-schaumburg.de/blog/2019-03-03-chef-cookbooks-and-kitchen/><meta http-equiv=content-language content="en-us"><meta property="og:type" content="website"><meta property="og:site_name" content="Patrick Schaumburg"><meta property="og:title" content="Chef cookbooks and kitchen"><meta property="og:url" content="https://www.p-schaumburg.de/blog/2019-03-03-chef-cookbooks-and-kitchen/"><meta property="og:image" content="https://www.p-schaumburg.de/images/"><meta name=twitter:title content="Patrick Schaumburg"><meta name=twitter:url content="https://www.p-schaumburg.de/blog/2019-03-03-chef-cookbooks-and-kitchen/"><meta name=twitter:image content="https://www.p-schaumburg.de/images/"><meta name=twitter:card content><title>Chef cookbooks and kitchen | Blog</title><link rel=alternate href=/blog/feed title="Patrick Schaumburg" type=application/rss+xml><link href=https://www.p-schaumburg.de/css/theme.css rel=stylesheet><link href=https://www.p-schaumburg.de/css/github.css rel=stylesheet><link href=https://www.p-schaumburg.de/css/style.css rel=stylesheet></head></head><body><div class="uk-container uk-container-center"><div class=tm-header><div class="tm-toolbar uk-clearfix uk-hidden-small"><div class=uk-float-right><div class=uk-panel><ul class=uk-subnav><li><a href=https://github.com/pschaumburg class="uk-icon-hover uk-icon-small uk-icon-github" target=_blank></a></li><li><a href=https://www.xing.com/profile/Patrick_Schaumburg2 class="uk-icon-hover uk-icon-small uk-icon-xing" target=_blank></a></li><li><a href=https://www.linkedin.com/in/patrick-schaumburg-600622ab/ class="uk-icon-hover uk-icon-small uk-icon-linkedin" target=_blank></a></li><li><a href=https://www.facebook.com/pschaumburg class="uk-icon-hover uk-icon-small uk-icon-facebook" target=_blank></a></li></ul></div></div></div><nav class=uk-navbar><a class=uk-navbar-brand href=/><img class="tm-logo uk-responsive-height uk-hidden-small" src=https://www.p-schaumburg.de/img/logo/pschaumburg_logo.png alt>
<img class="tm-logo-small uk-responsive-height uk-visible-small" src=https://www.p-schaumburg.de/img/logo/pschaumburg_logo.png alt></a><div class=uk-hidden-small><ul class=uk-navbar-nav><li><a href=https://www.p-schaumburg.de/>Blog</a></li><li><a href=/contact/ title=Contact>Contact</a></li><li><a href=/repositories/ title=Repositories>Repositories</a></li></ul></div><div class="uk-navbar-flip uk-visible-small"><a href=#offcanvas class=uk-navbar-toggle data-uk-offcanvas></a></div></nav></div><div id=content><main id=tm-content class=tm-content><article class=uk-article><a class="tm-article-featured-image uk-cover-background" href=https://www.p-schaumburg.de/blog/2019-03-03-chef-cookbooks-and-kitchen/ style=background-image:url(/img/blog/2019/Chefconf-Poster-Desktop-Automation-is-Happiness-1024.jpg)></a><div class="tm-article-content uk-position-relative"><div class="tm-article-date uk-text-center"><span class=tm-article-date-day>03</span>
<span class=tm-article-date-month>Mar</span></div><h1 class=uk-article-title><a href=https://www.p-schaumburg.de/blog/2019-03-03-chef-cookbooks-and-kitchen/>Chef cookbooks and kitchen</a></h1><p class=uk-article-meta>Written by Patrick Schaumburg</p><div class=uk-margin><p>Everyone wants to install always the same software in a specified version and configuration on their system. This mostly works with a script, but at some point, no one could ever read this or can be executed only once.</p><p>At this point Chef comes into the game and fixes this issue.</p><p>Chef is a DSL, which easily describes a desired state configuration in a ruby way (Yes, ruby is the language behind Chef).
Chef is working with cookbooks and can contain several recipes, which are doing different things. To test such cookbooks, Chef uses kitchen.</p><p>To give you some insights about Chef cookbooks and kitchen testing, you&rsquo;ll move on reading.</p><h2 id=kitchen>Kitchen</h2><p>Kitchen is a part of the ChefDK, which includes several kitchen-plugins like kitchen-ec2, kitchen-vagrant or kitchen-vcenter. The idea behind kitchen is to test cookbooks based upon their creation containing tests and a predefined run_list.</p><h2 id=general>General</h2><p>We&rsquo;re going into the materials, but have to do some prerequesites to move on with the cookbook generation and kitchen testing.
I will describe in a short way, how to install Docker and ChefDK and how we&rsquo;re going to start over with a cookbook creation.
Followed by an easy recipe, which contains a single resource we&rsquo;ll start with a test against kitchen.</p><p>So lets start!</p><h2 id=prerequesites>Prerequesites</h2><p>To run your first cookbook in a kitchen node, you have to have some prerequesites:</p><ul><li>Docker installed and running</li><li>ChefDK installed</li><li>a cookbook generated with some content (an easy file resource might help you out)</li><li>defined the run_list you want to run in .kitchen.yml</li><li>defined a driver, which you want to use</li></ul><h3 id=download-und-installation>Download und Installation</h3><h4 id=docker>Docker</h4><p>Go to <a href=https://www.docker.com/get-started>&ldquo;Get Started&rdquo;</a> and choose the wished download package of docker and install it.</p><p>To test, if everything works fine, just run a <code>docker ps</code>. If you&rsquo;re receiving an error, docker isn&rsquo;t running.</p><p>If the command works fine, we have created our base for creating kitchen nodes.</p><h3 id=download-and-install-chefdk>Download and install ChefDK</h3><p>The easiest way do have the ChefDK installed is, to download it directly from Chef, but brew would also work:
Option 1: Go to <a href=https://downloads.chef.io/chefdk/>downloads.chef.io</a> and download the appropriate package and install it
Option 2 (mac only): Open terminal and type <code>brew cask install chef/chef/chefdk</code></p><p>Both are currently installing the latest stable version of ChefDK. My preferred way is to use Option 1, as I can always define the version, I&rsquo;d like to use without any special versioning in the brew installation. It also happened, that the brew cask version was several versions behind the official one.</p><h3 id=create-cookbook-with-some-content>Create cookbook with some content</h3><p>Okay, we&rsquo;ve installed the latest version of the ChefDK. Now let&rsquo;s create a cookbook and add an easy small resource to it.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>chef generate cookbook kitchen_testing
</code></pre></div><p>Then go into the cookbook directory kitchen-testing/recipes and edit the default.rb recipe.</p><pre><code>vim kitchen_testing/recipes/default.rb
</code></pre><p>Add the following code and save the file</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>file <span style=color:#e6db74>&#34;/tmp/mykitchentest.md&#34;</span> <span style=color:#66d9ef>do</span>
  owner <span style=color:#e6db74>&#39;root&#39;</span>
  group <span style=color:#e6db74>&#39;root&#39;</span>
  mode <span style=color:#e6db74>&#39;0755&#39;</span>
  content <span style=color:#e6db74>&#39;made for cooking&#39;</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>Let&rsquo;s take a deeper look into the driver section.
The name defines the kitchen driver, which will be used. The official list of all drivers can be found <a href=https://docs.chef.io/kitchen.html#drivers>here</a>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>---
<span style=color:#66d9ef>driver</span>:
  <span style=color:#66d9ef>name</span>: vagrant

<span style=color:#66d9ef>provisioner</span>:
  <span style=color:#66d9ef>name</span>: chef_zero
  <span style=color:#66d9ef>always_update_cookbooks</span>: <span style=color:#66d9ef>true</span>

<span style=color:#66d9ef>verifier</span>:
  <span style=color:#66d9ef>name</span>: inspec

<span style=color:#66d9ef>platforms</span>:
  - <span style=color:#66d9ef>name</span>: ubuntu<span style=color:#ae81ff>-16.04</span>
  - <span style=color:#66d9ef>name</span>: centos<span style=color:#ae81ff>-7</span>

<span style=color:#66d9ef>suites</span>:
  - <span style=color:#66d9ef>name</span>: default
    <span style=color:#66d9ef>run_list</span>:
      - recipe[kitchen_test::default]
    <span style=color:#66d9ef>verifier</span>:
      <span style=color:#66d9ef>inspec_tests</span>:
        - test/integration/default
    <span style=color:#66d9ef>attributes</span>:
</code></pre></div><h3 id=kitchen-configuration>kitchen configuration</h3><p>Let&rsquo;s take a look into the configuration of kitchen. First of all, you should have a file named .kitchen.yml in your root directory of the cookbook.
For now, it&rsquo;s configured to use vagrant. We will change this to docker. Edit the file <code>.kitchen.yml</code> with your preferred editor.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>---
<span style=color:#66d9ef>driver</span>:
  <span style=color:#66d9ef>name</span>: docker
</code></pre></div><p>To check, if our configuration is fine, just run <code>kitchen list</code>. It will print out a short list with</p><pre><code>Instance             Driver  Provisioner  Verifier  Transport  Last Action    Last Error
default-ubuntu-1604  Docker  ChefZero     Inspec    Ssh        &lt;Not Created&gt;  &lt;None&gt;
default-centos-7     Docker  ChefZero     Inspec    Ssh        &lt;Not Created&gt;  &lt;None&gt;
</code></pre><p>This points us out, that we have one suite, which is named default and two different OS (Ubuntu 16.04 and CentOS 7).</p><p>We will create only the ubuntu machine. Run the command <code>kitchen create ubuntu</code>. This will only download and creating a docker container (the hint behind that command is, that it&rsquo;s using some regex, which only detects Ubuntu 16.04 as correct instance).
Now run <code>kitchen login ubuntu</code>. You&rsquo;ll see, that you can login into your instance. Do a short <code>ls -la /tmp</code> and see, that the file &lsquo;mykitchentest.md&rsquo; isn&rsquo;t present.</p><p>Okay, logout from that machine and let&rsquo;s start converging that newly created instance.
Run <code>kitchen converge ubuntu</code>.</p><p>You&rsquo;ll see, that the file /tmp/mykitchentest.md has changed. So our converging step worked.</p><p><code>kitchen destroy</code> will remove all our containers, which we used some seconds ago (only those, which are registered to the specified cookbook in kitchen).</p><p>-> This is the regular way of running kitchen. If you want to learn more about the kitchen configuration, you&rsquo;ll have to read some additional entries about kitchen advanced configuration, kitchen-vcenter and more in my blog, which will follow up in the next time. So we&rsquo;re finished here ;)</p></div></div></article></main></div><div id=tm-footer class=tm-footer><div class="uk-panel uk-panel-box"><div class="uk-container uk-container-center"><section class="uk-grid uk-grid-match" data-uk-grid-margin><div class="uk-width-medium-1-1 uk-row-first"><div class=uk-panel><ul class="uk-subnav uk-margin uk-flex uk-flex-center"><li><a href=#>Hannover, Germany</a></li><li><a href=mailto:info@p-schaumburg.de>info@p-schaumburg.de</a></li></ul></div></div></section></div></div></div></div></body></html>